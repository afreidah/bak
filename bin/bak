#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)
require 'bak'
require 'optparse'

options = {}
patternCount = 0
option_parser = OptionParser.new do |opts|
    opts.on("-d", "--date") do
        options[:date] = true
    end

    opts.on("-f", "--force") do
        options[:force] = true
    end

    opts.on("-n", "--no-bak") do
        options[:no_bak] = true
    end

    opts.on("-p POSTFIX") do |postfix|
        options[:postfix] = postfix
    end

    opts.on("-s PREFIX") do |prefix|
        options[:prefix] = prefix
    end

    opts.on("-R TEXT") do |text|
        options[:replace] ||= {}
        patternCount += 1
        options[:replace][:pattern] = Regexp.new(text) if patternCount == 1
        options[:replace][:replace] = text if patternCount == 2
    end
end
option_parser.parse!

# set defaults for values that weren't provided
options[:force] ||= false
options[:no_bak] ||= false

if ARGV.length > 0
    filenames = ARGV
else
    filenames = STDIN.read().split("\n")
end

filenames.each do |filename|
    generator = BackupNameGenerator.new(filename, options)
    copier = FileCopier.new(filename, generator)
    copier.start
end
